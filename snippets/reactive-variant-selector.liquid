{% assign product_form_id = 'product-form-' | append: section.id %}
{% assign selected_variant = product.selected_or_first_available_variant %}

  <div x-data="variantSelector({{ product | json }}, {{ selected_variant | json }})" class="variant-wrapper space-y-6 mt-6">

  <!-- Loop over options -->
  {% for option in product.options_with_values %}
    <div class="variant-group" data-option-index="{{ forloop.index0 }}">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-base font-semibold">
          Select {{ option.name }}:
        </h2>
      </div>

      <div class="grid grid-cols-4 gap-3">
        {% for value in option.values %}
          <button
            type="button"
            class="variant-button flex justify-center items-center rounded-lg p-2 bg-white border-2 border-solid cursor-pointer transition"
            :class="{
              '!border-[#22613a] !text-[#22613a] border-2': selectedOptions[{{ forloop.parentloop.index0 }}] === '{{ value }}',
              'border-gray-200 text-gray-700': selectedOptions[{{ forloop.parentloop.index0 }}] !== '{{ value }}'
            }"
            x-show="isOptionVisible({{ forloop.parentloop.index0 }}, '{{ value }}')"
            @click="selectOption({{ forloop.parentloop.index0 }}, '{{ value }}')">
            {{ value }}
          </button>
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

<!-- Product Form -->
<product-form class="product-form !m-0" data-section-id="{{ section.id }}">
  {%- form 'product'
    , product
    , id: product_form_id
    , class: 'form'
    , novalidate: 'novalidate'
    , data-type: 'add-to-cart-form' -%}
    <input
      type="hidden"
      name="id"
      :value="selectedVariant?.id"
      class="product-variant-id">

    <button
      type="submit"
      name="add"
      value="1"
      class="atc-button cta_product_from_submit_btn flex items-center justify-center rounded-lg button bg-[#22613a] hover:bg-[#368856] transition-colors shadow-xl tracking-normal button--full-width button--primary"
      :disabled="!selectedVariant">
      <span x-text="selectedVariant ? 'Add to cart' : 'Select options'"></span>
      <div class="ml-2 border-l pl-2 text-white/80">
        <span class="current-price" x-text="formatPrice(selectedVariant?.price)"></span>
      </div>
    </button>
  {%- endform -%}
</product-form>

<!-- Alpine Component Script -->
<script>
  document.addEventListener('alpine:init', () => {
  Alpine.data('variantSelector', (productData, initialVariant) => ({
    product: productData,
    selectedVariant: initialVariant,
    selectedOptions: [...initialVariant.options],

    selectOption(index, value) {
      this.selectedOptions[index] = value;

      // Find matching variant
      const matched = this.product.variants.find(v =>
        v.options.every((opt, i) => this.selectedOptions[i] === opt)
      );

      if (matched) this.selectedVariant = matched;
    },

    isOptionVisible(index, value) {
      // If it's the first option, always visible
      if (index === 0) return true;

      // Check if valid combination exists
      const prevSelection = this.selectedOptions[0];
      if (!prevSelection) return true;

      return this.product.variants.some(v =>
        v.options[0] === prevSelection &&
        v.options[index] === value &&
        v.available
      );
    },

    formatPrice(price) {
      if (!price) return '';
      return Shopify.formatMoney(price, "{{ shop.money_format }}");
    }
  }));
  });
</script>